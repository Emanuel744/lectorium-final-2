// sync_roles.js
// Script to sync Firestore `roles` documents with Auth UIDs using Firebase Admin SDK.
// Usage: node sync_roles.js /path/to/serviceAccountKey.json

const admin = require('firebase-admin');
const fs = require('fs');

async function main() {
  const keyPath = process.argv[2];
  if (!keyPath) {
    console.error('Provide path to service account JSON as first arg');
    process.exit(1);
  }

  const key = require(keyPath);
  admin.initializeApp({ credential: admin.credential.cert(key) });
  const auth = admin.auth();
  const db = admin.firestore();

  // Load roles collection
  const rolesSnap = await db.collection('roles').get();
  for (const doc of rolesSnap.docs) {
    const data = doc.data();
    if (!data.email) continue;
    try {
      const user = await auth.getUserByEmail(data.email);
      console.log(`Found user ${data.email} -> uid ${user.uid}`);
      await doc.ref.update({ uid: user.uid });
    } catch (err) {
      console.warn(`No user for ${data.email}: ${err.message}`);
    }
  }

  console.log('Sync complete');
  process.exit(0);
}

main().catch(err => { console.error(err); process.exit(1); });
